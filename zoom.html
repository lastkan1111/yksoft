<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>피하기 마스터: 좀비의 밤</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: auto;
      background: #222;
    }
    #retryButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 15px 30px;
      font-size: 20px;
      background: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <button id="retryButton">재도전!</button>
  <audio id="bgMusic" src="bgm.mp3" loop></audio>
  <audio id="hitSound" src="hit.mp3"></audio>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const retryButton = document.getElementById('retryButton');
    const bgMusic = document.getElementById('bgMusic');
    const hitSound = document.getElementById('hitSound');

    const playerImg = new Image();
    const zombieImg = new Image();
    playerImg.src = 'player.png';
    zombieImg.src = 'zombie.png';

    let player;
    let zombies = [];
    let keys = {};
    let score = 0;
    let gameOver = false;

    function initGame() {
      player = {
        x: canvas.width / 2 - 15,
        y: canvas.height - 60,
        width: 30,
        height: 30,
        speed: 5
      };
      zombies = [];
      keys = {};
      score = 0;
      gameOver = false;
      retryButton.style.display = 'none';
      bgMusic.currentTime = 0;
      bgMusic.play();
      gameLoop();
    }

    function drawPlayer() {
      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
    }

    function drawZombies() {
      zombies.forEach(z => {
        ctx.drawImage(zombieImg, z.x, z.y, z.width, z.height);
      });
    }

    function updateZombies() {
      zombies.forEach(z => z.y += z.speed);
      zombies = zombies.filter(z => z.y < canvas.height);
    }

    function spawnZombie() {
      const size = 30;
      const x = Math.random() * (canvas.width - size);
      zombies.push({ x, y: -size, width: size, height: size, speed: 2 + Math.random() * 2 });
    }

    function checkCollision() {
      for (let z of zombies) {
        if (player.x < z.x + z.width &&
            player.x + player.width > z.x &&
            player.y < z.y + z.height &&
            player.y + player.height > z.y) {
          gameOver = true;
          retryButton.style.display = 'block';
          hitSound.play();
          bgMusic.pause();
        }
      }
    }

    function drawScore() {
      ctx.fillStyle = 'white';
      ctx.font = '20px Arial';
      ctx.fillText("Score: " + score, 10, 30);
    }

    function updatePlayer() {
      if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
      if (keys['ArrowRight'] && player.x + player.width < canvas.width) player.x += player.speed;
    }

    function gameLoop() {
      if (gameOver) {
        ctx.fillStyle = 'white';
        ctx.font = '40px Arial';
        ctx.fillText("GAME OVER", canvas.width / 2 - 120, canvas.height / 2);
        return;
      }

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      updatePlayer();
      updateZombies();
      checkCollision();
      drawPlayer();
      drawZombies();
      drawScore();

      requestAnimationFrame(gameLoop);
    }

    setInterval(() => {
      if (!gameOver) {
        spawnZombie();
        score++;
      }
    }, 800);

    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);
    retryButton.addEventListener('click', initGame);

    // 이미지가 모두 로드된 후 게임 시작
    let imagesLoaded = 0;
    function tryStartGame() {
      imagesLoaded++;
      if (imagesLoaded === 2) {
        initGame();
      }
    }
    playerImg.onload = tryStartGame;
    zombieImg.onload = tryStartGame;
  </script>
</body>
</html>
